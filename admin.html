<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Jadwal</title>

<style>
:root{
  --primary:#3949ab;
  --bg:#f5f7fa;
  --card:#ffffff;
  --radius:16px;
  --pad:16px;
  font-family:'Segoe UI',Roboto,Arial;
}
body{margin:0;background:var(--bg);}
.header{
  height:60px;background:var(--primary);color:#fff;
  display:flex;align-items:center;padding:0 16px;
  font-size:20px;font-weight:600
}
.container{padding:16px}

/* Search */
.search-box{
  background:#fff;padding:10px 14px;border-radius:30px;
  margin-bottom:16px;box-shadow:0 3px 8px rgba(0,0,0,0.1);
  display:flex;align-items:center
}
.search-box input{
  border:none;outline:none;font-size:16px;width:100%
}

/* Filter */
.filter-group{display:flex;gap:10px;margin-bottom:16px}
.filter-group select{
  flex:1;padding:12px;border-radius:12px;border:1px solid #ccc;
  font-size:15px
}

/* Cards */
.card{
  background:var(--card);border-radius:var(--radius);
  padding:16px;margin-bottom:16px;
  box-shadow:0 4px 10px rgba(0,0,0,0.08);
  position:relative
}
.card-title{font-size:18px;font-weight:700;margin-top:8px}
.card-meta{font-size:15px;color:#444;margin-bottom:6px}
.more-btn{
  position:absolute;right:12px;top:12px;font-size:22px;
  background:none;border:none;cursor:pointer
}
.menu{
  position:absolute;right:12px;top:38px;background:#fff;
  border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.15);
  padding:6px;display:none;z-index:10
}
.menu div{
  padding:8px 16px;cursor:pointer;font-size:15px
}
.menu div:hover{background:#eee}
.add-btn{
  position:fixed;right:20px;bottom:20px;
  background:var(--primary);color:#fff;width:60px;
  height:60px;border-radius:50%;display:flex;
  align-items:center;justify-content:center;
  font-size:32px;border:none;cursor:pointer;
  box-shadow:0 6px 14px rgba(0,0,0,0.2)
}
.modal-bg{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.4);display:none;
  align-items:center;justify-content:center
}
.modal{
  background:#fff;width:90%;max-width:380px;border-radius:14px;padding:20px
}
.modal h2{margin:0 0 10px;font-size:20px;font-weight:700}
input,select{
  width:100%;padding:10px;margin-top:6px;margin-bottom:12px;
  font-size:15px;border-radius:10px;border:1px solid #ccc
}
.modal button{
  padding:10px 16px;font-size:16px;border:none;
  border-radius:10px;cursor:pointer;margin-top:4px
}
.btn-save{background:var(--primary);color:#fff}
.btn-cancel{background:#aaa;color:#fff;margin-left:6px}
.small-note{font-size:13px;color:#666;margin-top:-8px;margin-bottom:8px}
</style>
</head>

<body>
<div class="header">Admin Jadwal</div>
<div class="container">

  <!-- Search -->
  <div class="search-box">
    <input id="search" placeholder="Cari kegiatan atau tempat..." />
  </div>

  <!-- Filter Hari + Tempat -->
  <div class="filter-group">
    <select id="filterHari">
      <option value="">Semua Hari</option>
      <option>Senin</option>
      <option>Selasa</option>
      <option>Rabu</option>
      <option>Kamis</option>
      <option>Jumat</option>
      <option>Sabtu</option>
      <option>Minggu</option>
    </select>

    <select id="filterTempat">
      <option value="">Semua Tempat</option>
    </select>
  </div>

  <div id="list"></div>
</div>

<button class="add-btn" onclick="openAdd()">+</button>

<!-- Modal Form -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <h2 id="modalTitle">Tambah Jadwal</h2>

    <select id="f_hari">
      <option value="">Pilih Hari</option>
      <option>Senin</option><option>Selasa</option>
      <option>Rabu</option><option>Kamis</option>
      <option>Jumat</option><option>Sabtu</option><option>Minggu</option>
    </select>

    <input id="f_tanggal" type="date" />
    <input id="f_mulai" type="time" />

    <input id="f_selesai" placeholder="Waktu selesai (misal: 14:00 atau SELESAI)" />
    <div class="small-note">Kosongkan bila selesai = SELESAI</div>

    <input id="f_kegiatan" placeholder="Kegiatan" />
    <input id="f_tempat" placeholder="Tempat" />

    <button class="btn-save" onclick="saveData()">Simpan</button>
    <button class="btn-cancel" onclick="closeModal()">Batal</button>
  </div>
</div>

<script>
/* ====== GANTI LINK API-MU DI SINI ====== */
const API_URL = "https://script.google.com/macros/s/AKfycbzoT6zijm95CM5JRPdAMVJM0MKQoLi0pxJ9V1vGlN79VWl6uf8eFbjTztIYpUCQJWtptw/exec";

let dataRaw = [];
let editIndex = -1;

/* ====== FORMAT WAKTU UNIVERSAL ====== */
function formatWaktuUniversal(val){
  if(!val) return "";
  const s = String(val).trim();
  if(s.toLowerCase() === "selesai") return "SELESAI";
  const cleaned = s.replace(".", ":");
  let [h,m] = cleaned.split(":");
  if(!m) m="00";
  return `${h.padStart(2,"0")}:${m.padStart(2,"0")}`;
}

/* ====== FORMAT TANGGAL ====== */
function formatTanggalAllCaps(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(isNaN(d)) return iso.toUpperCase();
  const hari = d.toLocaleDateString("id-ID",{weekday:"long"}).toUpperCase();
  const tanggal = String(d.getDate()).padStart(2,"0");
  const bulan = d.toLocaleDateString("id-ID",{month:"long"}).toUpperCase();
  return `${hari}, ${tanggal} ${bulan} ${d.getFullYear()}`;
}

/* ====== LOAD DATA ====== */
async function loadData(){
  const res = await fetch(API_URL);
  const data = await res.json();

  dataRaw = data.map(r=>({
    hari: r.hari,
    tanggal: r.tanggal,
    waktu_mulai: r.waktu_mulai,
    waktu_selesai: r.waktu_selesai,
    kegiatan: r.kegiatan,
    tempat: r.tempat
  }));

  // filter tempat
  const tempatSet = new Set();
  dataRaw.forEach(r=>r.tempat && tempatSet.add(r.tempat));
  const sel = document.getElementById("filterTempat");
  sel.innerHTML = '<option value="">Semua Tempat</option>';
  [...tempatSet].forEach(t=>{
    const o = document.createElement("option"); o.value=t; o.textContent=t;
    sel.appendChild(o);
  });

  render();
}

/* ====== RENDER ====== */
function render(){
  const q = document.getElementById("search").value.toLowerCase();
  const fH = document.getElementById("filterHari").value;
  const fT = document.getElementById("filterTempat").value;

  const list = document.getElementById("list");
  list.innerHTML = "";

  const filtered = dataRaw.filter(r=>{
    if(fH && r.hari !== fH) return false;
    if(fT && r.tempat !== fT) return false;
    const text = (r.kegiatan+" "+r.tempat+" "+r.hari).toLowerCase();
    if(q && !text.includes(q)) return false;
    return true;
  });

  if(filtered.length === 0){
    list.innerHTML = '<div style="padding:16px;color:#666">Tidak ada jadwal.</div>';
    return;
  }

  filtered.forEach((r,i)=>{
    const tanggal = formatTanggalAllCaps(r.tanggal);
    const mulai = formatWaktuUniversal(r.waktu_mulai);
    const selesai = formatWaktuUniversal(r.waktu_selesai);

    const card = document.createElement("div");
    card.className="card";
    card.innerHTML = `
      <button class="more-btn" onclick="toggleMenu(${i})">‚ãÆ</button>
      <div class="menu" id="menu-${i}">
        <div onclick="editItem(${i})">Edit</div>
        <div onclick="deleteItem(${i})" style="color:#e53935">Hapus</div>
      </div>

      <div class="card-meta" style="font-weight:700">${tanggal}</div>
      <div class="card-meta">${mulai} - ${selesai}</div>
      <div class="card-title">${r.kegiatan.toUpperCase()}</div>
      <div class="card-meta">üìç ${r.tempat}</div>
    `;
    list.appendChild(card);
  });
}

document.getElementById("search").addEventListener('input', render);
document.getElementById("filterHari").addEventListener('change', render);
document.getElementById("filterTempat").addEventListener('change', render);

/* ====== MENU ====== */
function toggleMenu(i){
  document.querySelectorAll('.menu').forEach(m=>m.style.display='none');
  const m = document.getElementById(`menu-${i}`);
  if(m) m.style.display = m.style.display==='block' ? 'none' : 'block';
}

/* ====== ADD / EDIT ====== */
function openAdd(){
  editIndex = -1;
  document.getElementById('modalTitle').innerText = "Tambah Jadwal";
  document.getElementById('f_hari').value="";
  document.getElementById('f_tanggal').value="";
  document.getElementById('f_mulai').value="";
  document.getElementById('f_selesai').value="";
  document.getElementById('f_kegiatan').value="";
  document.getElementById('f_tempat').value="";
  document.getElementById('modalBg').style.display="flex";
}

function closeModal(){
  document.getElementById('modalBg').style.display="none";
}

function editItem(i){
  editIndex = i;
  const r = dataRaw[i];
  document.getElementById('modalTitle').innerText="Edit Jadwal";
  document.getElementById('f_hari').value=r.hari;

  const d = new Date(r.tanggal);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  document.getElementById('f_tanggal').value = `${y}-${m}-${dd}`;

  document.getElementById('f_mulai').value = formatWaktuUniversal(r.waktu_mulai);
  document.getElementById('f_selesai').value = (r.waktu_selesai==="SELESAI") ? "" : formatWaktuUniversal(r.waktu_selesai);
  document.getElementById('f_kegiatan').value=r.kegiatan;
  document.getElementById('f_tempat').value=r.tempat;

  document.getElementById('modalBg').style.display="flex";
}

/* ====== SAVE ====== */
async function saveData(){
  const rawSelesai = document.getElementById('f_selesai').value.trim();
  const payload = {
    hari: document.getElementById('f_hari').value,
    tanggal: document.getElementById('f_tanggal').value,
    waktu_mulai: document.getElementById('f_mulai').value,
    waktu_selesai: rawSelesai==="" ? "SELESAI" : rawSelesai,
    kegiatan: document.getElementById('f_kegiatan').value,
    tempat: document.getElementById('f_tempat').value
  };

  const params = new URLSearchParams(payload);

  if(editIndex === -1){
    params.append("action","add");
  } else {
    params.append("action","edit");
    params.append("row", editIndex+2);
  }

  await fetch(API_URL + "?" + params.toString());

  closeModal();
  loadData();
}

/* ====== DELETE ====== */
async function deleteItem(i){
  if(!confirm("Yakin ingin menghapus jadwal ini?")) return;
  const params = new URLSearchParams();
  params.append("action","delete");
  params.append("row", i+2);
  await fetch(API_URL + "?" + params.toString());
  loadData();
}

/* INIT */
loadData();
</script>

</body>
</html>
