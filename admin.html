<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Jadwal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        input,
        select,
        button {
            padding: 8px;
            margin: 5px 0;
            width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        table th,
        table td {
            padding: 10px;
            border: 1px solid #999;
            font-size: 14px;
            text-align: left;
        }

        .container {
            max-width: 900px;
            margin: auto;
        }

        #loading {
            font-size: 16px;
            color: green;
        }

        .btn {
            padding: 8px 14px;
            cursor: pointer;
            border: none;
            color: white;
            background: #007bff;
            border-radius: 5px;
        }

        .btn-red {
            background: red;
        }

        .btn-yellow {
            background: orange;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2>ADMIN â€” Input Jadwal</h2>

        <label>Tanggal:</label>
        <input id="f_tanggal" type="date" />

        <label>Waktu Mulai:</label>
        <input id="f_mulai" type="time" />

        <label>Waktu Selesai:</label>
        <!-- FIX: tidak pakai type="time" -->
        <input id="f_selesai" placeholder="Misal: 14:00 atau SELESAI" />

        <label>Kegiatan:</label>
        <input id="f_kegiatan" placeholder="Nama kegiatan" />

        <label>Tempat:</label>
        <input id="f_tempat" placeholder="Tempat kegiatan" />

        <button class="btn" onclick="simpanData()">Simpan</button>

        <p id="loading"></p>

        <h3>Data Jadwal</h3>
        <table id="tabelData">
            <thead>
                <tr>
                    <th>Tanggal</th>
                    <th>Mulai</th>
                    <th>Selesai</th>
                    <th>Kegiatan</th>
                    <th>Tempat</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

    </div>

    <script>
        const scriptURL =
            "https://script.google.com/macros/s/AKfycbwf3x7v8GVwbaA3X_8_0eRXMLznnvGy7WmMoE7YV68XUSqFhrC2_h356p3qsvaVlQw/exec";

        let editRow = null;

        function loadData() {
            fetch(scriptURL + "?action=read")
                .then(res => res.json())
                .then(json => {
                    const tbody = document.querySelector("#tabelData tbody");
                    tbody.innerHTML = "";

                    json.data.forEach((row, idx) => {
                        let tr = document.createElement("tr");

                        tr.innerHTML = `
                            <td>${row.tanggal}</td>
                            <td>${row.mulai}</td>
                            <td>${row.selesai}</td>
                            <td>${row.kegiatan}</td>
                            <td>${row.tempat}</td>
                            <td>
                                <button class="btn-yellow" onclick="editBaris(${idx})">Edit</button>
                                <button class="btn-red" onclick="hapusBaris(${idx})">Hapus</button>
                            </td>
                        `;

                        tbody.appendChild(tr);
                    });
                });
        }

        function formatWaktuUniversal(waktu) {
            waktu = waktu.trim().toUpperCase();

            if (waktu === "SELESAI") return "SELESAI";

            waktu = waktu.replace(".", ":");

            if (/^\d$/.test(waktu)) return `0${waktu}:00`;
            if (/^\d\d$/.test(waktu)) return `${waktu}:00`;

            if (/^\d:\d\d$/.test(waktu)) return `0${waktu}`;
            if (/^\d\d:\d$/.test(waktu)) return `${waktu}0`;

            if (/^\d\d:\d\d$/.test(waktu)) return waktu;

            return waktu;
        }

        function simpanData() {
            let tanggal = document.getElementById("f_tanggal").value;
            let mulai = document.getElementById("f_mulai").value;
            let selesai = formatWaktuUniversal(document.getElementById("f_selesai").value);
            let kegiatan = document.getElementById("f_kegiatan").value;
            let tempat = document.getElementById("f_tempat").value;

            if (!tanggal || !mulai || !selesai || !kegiatan || !tempat) {
                alert("Semua field wajib diisi!");
                return;
            }

            document.getElementById("loading").innerText = "Menyimpan...";

            let data = {
                action: editRow === null ? "create" : "update",
                row: editRow,
                tanggal,
                mulai,
                selesai,
                kegiatan,
                tempat
            };

            fetch(scriptURL, {
                method: "POST",
                body: JSON.stringify(data)
            })
                .then(() => {
                    document.getElementById("loading").innerText = "Tersimpan!";
                    setTimeout(() => document.getElementById("loading").innerText = "", 1500);
                    kosongkanForm();
                    loadData();
                });
        }

        function editBaris(i) {
            fetch(scriptURL + "?action=read")
                .then(res => res.json())
                .then(json => {
                    let row = json.data[i];
                    editRow = i;

                    document.getElementById("f_tanggal").value = row.tanggal;
                    document.getElementById("f_mulai").value = row.mulai === "SELESAI" ? "" : row.mulai;
                    document.getElementById("f_selesai").value = row.selesai;
                    document.getElementById("f_kegiatan").value = row.kegiatan;
                    document.getElementById("f_tempat").value = row.tempat;
                });
        }

        function hapusBaris(i) {
            if (!confirm("Hapus data ini?")) return;

            fetch(scriptURL, {
                method: "POST",
                body: JSON.stringify({ action: "delete", row: i })
            }).then(() => loadData());
        }

        function kosongkanForm() {
            editRow = null;
            document.querySelectorAll("input").forEach(i => i.value = "");
        }

        loadData();
    </script>

</body>

</html>
