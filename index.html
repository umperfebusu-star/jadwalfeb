<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Jadwal Kegiatan — FEB USU</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg1:#041728;
    --bg2:#06273a;
    --accent1:#3f51b5;
    --accent2:#145ea8;
    --glass-border: rgba(255,255,255,0.08);
  }
  *{box-sizing:border-box}

  body{
    margin:0;
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background: linear-gradient(180deg,var(--bg1) 0%, var(--bg2) 60%);
    color: #eaf2ff;
    padding-bottom:60px;
  }

  /* Topbar */
  .topbar{
    position:sticky; top:0; z-index:60;
    background: linear-gradient(90deg,var(--accent1), var(--accent2));
    padding:16px 18px;
    text-align:center;
    font-weight:800;
    font-size:18px;
    color:#fff;
    box-shadow:0 6px 18px rgba(2,8,23,0.45);
  }

  .container{
    max-width:880px;
    margin:22px auto;
    padding:18px;
  }

  .title{
    text-align:center;
    font-size:30px;
    font-weight:800;
    margin-bottom:18px;
  }

  /* Search */
  .search{
    width:100%;
    padding:12px 14px;
    border-radius:12px;
    border:1px solid var(--glass-border);
    background:rgba(255,255,255,0.04);
    color:#fff;
    outline:none;
    font-size:15px;
  }

  /* Filters */
  .filters{
    display:flex;
    gap:12px;
    margin-top:12px;
  }

  .filter{
    flex:1;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--glass-border);
    background:rgba(255,255,255,0.04);
  }

  /* PERBAIKAN WARNA DROPDOWN — SUPAYA TERBACA */
  .filter select{
    width:100%;
    background-color:rgba(0,0,0,0.4);
    color:#fff;
    border:0;
    outline:none;
    font-size:14px;
  }

  .filter select option{
    background-color:#0d2030;
    color:white;
  }

  .controls{
    display:flex;
    gap:8px;
    margin-top:12px;
  }

  .btn{
    padding:9px 12px;
    border-radius:10px;
    background:rgba(255,255,255,0.04);
    border:1px solid var(--glass-border);
    color:#fff;
    cursor:pointer;
    font-weight:600;
    font-size:14px;
  }

  /* List */
  #list{
    margin-top:18px;
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  .card{
    padding:16px;
    border-radius:12px;
    background:rgba(255,255,255,0.04);
    border:1px solid var(--glass-border);
    opacity:0;
    transform:translateY(10px);
    transition:all .4s;
  }
  .card.show{
    opacity:1; transform:translateY(0);
  }

  .card.today{
    border:1px solid rgba(99,102,241,0.5);
    background:rgba(99,102,241,0.09);
  }

  .head{
    display:flex; justify-content:space-between;
    font-size:15px;
    font-weight:700;
  }
  .kegiatan{margin-top:10px; font-size:18px; font-weight:800;}
  .tempat{margin-top:8px; opacity:.8;}

  .empty{
    padding:22px; border-radius:12px;
    text-align:center;
    background:rgba(255,255,255,0.04);
    border:1px solid var(--glass-border);
  }
</style>
</head>

<body>
<div class="topbar">FAKULTAS EKONOMI DAN BISNIS — USU</div>

<div class="container">

  <div class="title">Jadwal Kegiatan</div>

  <input id="searchBox" class="search" placeholder="Cari kegiatan, tempat, atau hari..." />

  <div class="filters">
    <div class="filter">
      <select id="filterHari">
        <option value="Semua">Filter: Semua Hari</option>
        <option value="SENIN">Senin</option>
        <option value="SELASA">Selasa</option>
        <option value="RABU">Rabu</option>
        <option value="KAMIS">Kamis</option>
        <option value="JUMAT">Jumat</option>
        <option value="SABTU">Sabtu</option>
        <option value="MINGGU">Minggu</option>
      </select>
    </div>

    <div class="filter">
      <select id="filterTempat">
        <option value="Semua">Filter: Semua Ruangan</option>
      </select>
    </div>
  </div>

  <div class="controls">
    <button id="sortBtn" class="btn">Sort: Terbaru ↓</button>
    <button id="refreshBtn" class="btn">⟳ Refresh</button>
  </div>

  <div id="list"></div>

</div>

<script>
const sheetURL = "https://script.google.com/macros/s/AKfycbzoT6zijm95CM5JRPdAMVJM0MKQoLi0pxJ9V1vGlN79VWl6uf8eFbjTztIYpUCQJWtptw/exec";

const hariNama = ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
const bulanNama = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];

function formatTanggalDisplay(t){
  if(!t) return "";
  const d = new Date(t);
  if(isNaN(d)) return t;
  return hariNama[d.getDay()].toUpperCase() + ", " +
    d.getDate() + " " + bulanNama[d.getMonth()] + " " + d.getFullYear();
}

function formatWaktu(w){
  if(!w) return "";
  if(w.toUpperCase().includes("SELESAI")) return "SELESAI";
  if(/^\d{1,2}$/.test(w)) return w.padStart(2,"0") + ":00";
  if(/^\d{1,2}:\d{1,2}$/.test(w)){
    let [h,m] = w.split(":");
    return h.padStart(2,"0") + ":" + m.padStart(2,"0");
  }
  return w;
}

let cachedData = [];
let sortDesc = true;

async function fetchData(){
  try{
    const r = await fetch(sheetURL + "?action=read");
    const j = await r.json();
    return j.map(x => ({
      ...x,
      _date: new Date(x.tanggal)
    }));
  }catch(e){
    console.error(e);
    return [];
  }
}

function populateTempatFilter(data){
  const sel = document.getElementById("filterTempat");
  sel.querySelectorAll("option:not([value='Semua'])").forEach(o => o.remove());

  const places = [...new Set(data.map(a => a.tempat).filter(Boolean))].sort();
  places.forEach(p=>{
    const o = document.createElement("option");
    o.value = p; o.textContent = p;
    sel.appendChild(o);
  });
}

function renderList(data){
  const list = document.getElementById("list");
  list.innerHTML = "";

  const q = document.getElementById("searchBox").value.toLowerCase();
  const fHari = document.getElementById("filterHari").value;
  const fTempat = document.getElementById("filterTempat").value;

  let arr = [...data];

  arr.sort((a,b)=> sortDesc ? b._date - a._date : a._date - b._date);

  let visible = 0;

  arr.forEach((item,i)=>{
    const day = hariNama[item._date.getDay()].toUpperCase();
    if(fHari !== "Semua" && day !== fHari) return;
    if(fTempat !== "Semua" && item.tempat !== fTempat) return;

    const full = (item.kegiatan + " " + item.tempat + " " + day).toLowerCase();
    if(q && !full.includes(q)) return;

    visible++;

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="head">
        <div>${formatTanggalDisplay(item.tanggal)}</div>
        <div>${formatWaktu(item.waktu_mulai)} - ${formatWaktu(item.waktu_selesai)}</div>
      </div>
      <div class="kegiatan">${item.kegiatan}</div>
      <div class="tempat">${item.tempat}</div>
    `;
    list.appendChild(card);

    setTimeout(()=>card.classList.add("show"), 20*i);
  });

  if(visible === 0){
    list.innerHTML = `<div class="empty">Tidak ada jadwal.</div>`;
  }
}

/* REFRESH — PERBAIKAN */
document.getElementById("refreshBtn").addEventListener("click", async ()=>{
  const btn = document.getElementById("refreshBtn");
  btn.textContent = "⟳ Loading...";

  document.getElementById("searchBox").value = "";
  document.getElementById("filterHari").value = "Semua";
  document.getElementById("filterTempat").value = "Semua";

  cachedData = await fetchData();
  populateTempatFilter(cachedData);
  renderList(cachedData);

  setTimeout(()=> btn.textContent = "⟳ Refresh", 400);
});

document.getElementById("sortBtn").addEventListener("click", ()=>{
  sortDesc = !sortDesc;
  document.getElementById("sortBtn").textContent = sortDesc ? "Sort: Terbaru ↓" : "Sort: Terlama ↑";
  renderList(cachedData);
});

document.getElementById("searchBox").addEventListener("input", ()=>{
  clearTimeout(window._deb);
  window._deb = setTimeout(()=>renderList(cachedData),200);
});

document.getElementById("filterHari").addEventListener("change", ()=>renderList(cachedData));
document.getElementById("filterTempat").addEventListener("change", ()=>renderList(cachedData));

(async()=>{
  cachedData = await fetchData();
  populateTempatFilter(cachedData);
  renderList(cachedData);
})();
</script>

</body>
</html>
